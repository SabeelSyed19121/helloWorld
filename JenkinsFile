
pipeline {
  agent any

  options {
    timestamps()
  }

  environment {
    SOURCE_BRANCH = 'multi' // Stage 1 & merge source
    TARGET_BRANCH = 'main'  // Stage 2 target & Stage 3 checkout
  }

  stages {

    stage('Stage 1: Checkout multi & say hello') {
      steps {
        // Use job/folder SCM config (no credentials in code)
        checkout scm

        sh '''
          set -euxo pipefail

          echo "Fetching remote refs ..."
          git fetch --all --prune

          echo "Checking out ${SOURCE_BRANCH} ..."
          git checkout -B "${SOURCE_BRANCH}" "origin/${SOURCE_BRANCH}"

          echo "hello success"
          echo "Stage 1 successful: ran echo on ${SOURCE_BRANCH}"
        '''
      }
    }

    stage('Stage 2: Merge multi -> main') {
      steps {
        sh '''
          set -euxo pipefail

          echo "Syncing ${TARGET_BRANCH} ..."
          git fetch origin

          echo "Switching to ${TARGET_BRANCH} ..."
          git checkout -B "${TARGET_BRANCH}" "origin/${TARGET_BRANCH}"

          echo "Merging ${SOURCE_BRANCH} into ${TARGET_BRANCH} ..."
          git merge --no-ff --no-edit "origin/${SOURCE_BRANCH}"

          echo "Pushing ${TARGET_BRANCH} to origin ..."
          git push origin "${TARGET_BRANCH}"

          echo "Stage 2 successful: merged ${SOURCE_BRANCH} -> ${TARGET_BRANCH} ✅"
        '''
      }
    }

    stage('Stage 3: Checkout main & run file1.txt') {
      steps {
        sh '''
          set -euxo pipefail

          echo "Ensuring latest ${TARGET_BRANCH} ..."
          git fetch origin
          git checkout -B "${TARGET_BRANCH}" "origin/${TARGET_BRANCH}"
          git reset --hard "origin/${TARGET_BRANCH}"

          if [ ! -f file1.txt ]; then
            echo "ERROR: file1.txt not found on ${TARGET_BRANCH}"
            exit 1
          fi

          # Make executable if needed, then run; if it isn't a script, run via bash
          chmod +x file1.txt || true
          if head -n1 file1.txt | grep -qE '^#!'; then
            ./file1.txt
          else
            bash file1.txt
          fi

          echo "Stage 3 successful: file1.txt executed on ${TARGET_BRANCH} ✅"
        '''
      }
    }
  }

  post {
    success { echo 'Pipeline completed successfully ✅' }
    failure { echo 'Pipeline failed ❌' }
    always  { echo 'execution completed' }
  }
}

