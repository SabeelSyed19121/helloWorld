
pipeline {
  agent any

  options {
    timestamps()
  }

  environment {
    MULTI_BRANCH = 'multi'
    MAIN_BRANCH  = 'main'
  }

  stages {
    stage('Stage 1: Checkout multi & say hello') {
      steps {
        // Uses the Multibranch SCM configuration (no credentials in code)
        checkout scm

        // Use bash explicitly (so we can use pipefail safely across distros)
        sh '''
          bash -euo pipefail <<'BASH'
          echo "Fetching remote refs ..."
          git fetch --all --prune

          echo "Switching to ${MULTI_BRANCH} ..."
          git checkout -B "${MULTI_BRANCH}" "origin/${MULTI_BRANCH}"

          echo 'hello success'
          echo "Stage 1 successful: echoed message on ${MULTI_BRANCH}"
          BASH
        '''
      }
    }

    stage('Stage 2: Checkout main & run file1.txt') {
      steps {
        sh '''
          bash -euo pipefail <<'BASH'
          echo "Fetching and switching to ${MAIN_BRANCH} ..."
          git fetch origin
          git checkout -B "${MAIN_BRANCH}" "origin/${MAIN_BRANCH}"
          git reset --hard "origin/${MAIN_BRANCH}"

          if [ ! -f file1.txt ]; then
            echo "ERROR: file1.txt not found on ${MAIN_BRANCH}"
            exit 1
          fi

          echo "Running file1.txt on ${MAIN_BRANCH} ..."
          # Run with bash so it doesn't need +x or a shebang
          bash file1.txt

          echo "Stage 2 successful: file1.txt executed on ${MAIN_BRANCH} ✅"
          BASH
        '''
      }
    }
  }

  post {
    success { echo 'Pipeline completed successfully ✅' }
    failure { echo 'Pipeline failed ❌' }
    always  { echo 'execution completed' }
  }
}


